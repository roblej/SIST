<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.ex0917_bbs.mapper.BbsMapper">
    <resultMap id="map1" type="com.sist.ex0917_bbs.vo.BbsVO">
    <id property="b_idx" column="b_idx"/>
    <collection property="c_List" ofType="com.sist.ex0917_bbs.vo.CommVO"
    select="com.sist.ex0917_bbs.mapper.CommMapper.commList" column="b_idx"/>
    </resultMap>

    <!-- 총 게시물의 수를 반환하는 기능 -->
    <select id="totalCount" resultType="int" parameterType="Map">
        select count(*) from bbs_t where status = 0 and bname = #{bname}
        <if test="searchType != null and searchValue != null">
            <choose>
                <when test="searchType == 0">
                    and subject like Concat('%', #{searchValue}, '%')
                </when>
                <when test="searchType == 1">
                    and writer like Concat('%', #{searchValue}, '%')
                </when>
                <when test="searchType == 2">
                    and content like Concat('%', #{searchValue}, '%')
                </when>
                <when test="searchType == 3">
                    and write_date like Concat('%', #{searchValue}, '%')
                </when>
            </choose>
        </if>
    </select>

    <!-- 원글들을 원하는 만큼 가져오는 기능 -->
    <select id="list" resultMap="map1">
        select * from(
            select @RN:=@RN+1 as rnum, a.* from(
                select * from bbs_t
                where status = 0 and bname = #{bname}
                <if test="searchType != null and searchValue != null and searchValue != ''">
                    <choose>
                        <when test="searchType == '0'">
                            and subject like Concat('%', #{searchValue}, '%')
                        </when>
                        <when test="searchType == '1'">
                            and writer like Concat('%', #{searchValue}, '%')
                        </when>
                        <when test="searchType == '2'">
                            and content like Concat('%', #{searchValue}, '%')
                        </when>
                        <when test="searchType == '3'">
                            and write_date like Concat('%', #{searchValue}, '%')
                        </when>
                    </choose>
                </if>
                order by b_idx desc
            ) a,(select @RN:=0) b
        ) c where c.rnum between #{begin} and #{end}
    </select>
    <!-- 원글 저장 -->
    <insert id="add" parameterType="com.sist.ex0917_bbs.vo.BbsVO">
        insert into bbs_t (subject, writer, content, file_name, ori_name, pwd, write_date, ip, hit, bname, status)
        values (#{subject}, #{writer}, #{content}, #{file_name}, #{ori_name}, #{pwd}, now(), #{ip}, 0, #{bname}, 0)
    </insert>
    <!-- b_idx를 인자로 받아서 원글 검색 -->
    <select id="getBbs" resultMap="map1" parameterType="String">
        select * from bbs_t where b_idx = #{b_idx}
    </select>
    <!-- 조회수 증가 -->
    <update id="hit" parameterType="String">
        update bbs_t set hit = hit + 1 where b_idx = #{b_idx}
    </update>
    <!-- 원글 수정 -->
    <update id="edit" parameterType="Map">
        update bbs_t set
        <trim prefix="set" suffixOverrides=",">
            subject = #{subject},
            content = #{content},
            <if test="file_name != null">
            file_name = #{file_name},
            ori_name = #{ori_name}
            </if>
        </trim>
        where b_idx = #{b_idx}
    </update>
    <!-- 원글 삭제 -->
    <update id="del" parameterType="String">
        update bbs_t set status = 1 where b_idx = #{b_idx}
    </update>
</mapper>